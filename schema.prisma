// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============== ENUMS ==============

enum UserRole {
  BUYER
  SELLER
  ADMIN
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ProductStatus {
  DRAFT
  ACTIVE
  INACTIVE
  ARCHIVED
}

enum MatchaGrade {
  CEREMONIAL
  PREMIUM
  CULINARY
  FOOD_SERVICE
  INDUSTRIAL
}

enum MatchaOrigin {
  KYOTO_UJIREGION
  NISHIO_AICHI
  KAGOSHIMA
  SHIZUOKA
  FUKUOKA
  OTHER_JAPAN
  CHINA
  OTHER
}

enum RfqStatus {
  DRAFT
  SUBMITTED
  QUOTED
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum QuoteStatus {
  DRAFT
  SUBMITTED
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ShippingMethod {
  UPS_GROUND
  UPS_EXPRESS
  FEDEX_GROUND
  FEDEX_EXPRESS
  FREIGHT_LTL
  FREIGHT_FTL
  SEA_FREIGHT
  AIR_FREIGHT
}

enum MessageType {
  TEXT
  SYSTEM
  QUOTE_UPDATE
  ORDER_UPDATE
}

enum InsightCategory {
  MARKET_TRENDS
  INDUSTRY_NEWS
  PRODUCT_SPOTLIGHT
  SOURCING_TIPS
  COMPLIANCE_UPDATE
}

enum ComplianceCategory {
  IMPORT_EXPORT
  FOOD_SAFETY
  LABELING
  CERTIFICATION
  PACKAGING
  CUSTOMS
}

// ============== USER & PROFILES ==============

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  passwordHash      String
  name              String
  role              UserRole  @default(BUYER)
  companyName       String?
  isVerified        Boolean   @default(false)
  isActive          Boolean   @default(true)
  refreshTokenHash  String?
  
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  lastLoginAt       DateTime?

  // Relations
  company           Company?  @relation(fields: [companyId], references: [id])
  companyId         String?
  
  sellerProfile     SellerProfile?
  buyerProfile      BuyerProfile?
  
  sentMessages      Message[] @relation("SentMessages")
  
  // Admin actions
  verifiedSellers   SellerVerification[] @relation("VerifiedBy")
  createdInsights   InsightPost[]
  createdRules      ComplianceRule[]

  @@index([email])
  @@index([role])
  @@index([companyId])
  @@map("users")
}

model Company {
  id              String    @id @default(cuid())
  name            String
  description     String?
  website         String?
  phone           String?
  email           String?
  
  // Address
  addressLine1    String?
  addressLine2    String?
  city            String?
  state           String?
  postalCode      String?
  country         String    @default("US")
  
  logoUrl         String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  users           User[]
  sellerProfile   SellerProfile?
  buyerProfile    BuyerProfile?

  @@map("companies")
}

model SellerProfile {
  id                  String    @id @default(cuid())
  
  // Business details
  businessLicense     String?
  taxId               String?
  yearsInBusiness     Int?
  annualRevenue       String?
  employeeCount       String?
  
  // Capabilities
  exportCapable       Boolean   @default(false)
  organicCertified    Boolean   @default(false)
  jgapCertified       Boolean   @default(false)
  haccpCertified      Boolean   @default(false)
  
  // Matcha specifics
  primaryOrigins      MatchaOrigin[]
  primaryGrades       MatchaGrade[]
  minimumOrderValue   Decimal?  @db.Decimal(10, 2)
  leadTimeDays        Int?
  
  // Profile
  bio                 String?
  bannerUrl           String?
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String    @unique
  
  company             Company   @relation(fields: [companyId], references: [id])
  companyId           String    @unique
  
  verification        SellerVerification?
  products            Product[]
  quotes              Quote[]
  orders              Order[]   @relation("SellerOrders")

  @@index([userId])
  @@index([companyId])
  @@map("seller_profiles")
}

model SellerVerification {
  id              String              @id @default(cuid())
  status          VerificationStatus  @default(PENDING)
  
  // Documents
  documentsUrls   String[]
  
  // Review
  reviewNotes     String?
  reviewedAt      DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  sellerProfile   SellerProfile @relation(fields: [sellerProfileId], references: [id], onDelete: Cascade)
  sellerProfileId String        @unique
  
  reviewedBy      User?     @relation("VerifiedBy", fields: [reviewedById], references: [id])
  reviewedById    String?

  @@index([status])
  @@map("seller_verifications")
}

model BuyerProfile {
  id                  String    @id @default(cuid())
  
  // Business details
  businessType        String?   // Restaurant, Retailer, Distributor, Manufacturer, etc.
  taxId               String?
  
  // Purchasing preferences
  annualMatchaVolume  String?   // kg/year estimate
  preferredGrades     MatchaGrade[]
  preferredOrigins    MatchaOrigin[]
  
  // Shipping
  shippingAddressLine1  String?
  shippingAddressLine2  String?
  shippingCity          String?
  shippingState         String?
  shippingPostalCode    String?
  shippingCountry       String  @default("US")
  
  createdAt           DateTime  @default(now())
  updatedAt           DateTime  @updatedAt
  
  // Relations
  user                User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId              String    @unique
  
  company             Company   @relation(fields: [companyId], references: [id])
  companyId           String    @unique
  
  rfqs                Rfq[]
  orders              Order[]   @relation("BuyerOrders")

  @@index([userId])
  @@index([companyId])
  @@map("buyer_profiles")
}

// ============== PRODUCTS & INVENTORY ==============

model Product {
  id              String        @id @default(cuid())
  name            String
  slug            String        @unique
  description     String?
  shortDescription String?
  
  // Classification
  grade           MatchaGrade
  origin          MatchaOrigin
  
  // Attributes (JSON for flexibility)
  attributes      Json?         // { flavor_profile, color, mesh_size, etc. }
  
  // Status
  status          ProductStatus @default(DRAFT)
  isFeatured      Boolean       @default(false)
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  seller          SellerProfile @relation(fields: [sellerId], references: [id], onDelete: Cascade)
  sellerId        String
  
  skus            Sku[]
  images          ProductImage[]
  rfqLineItems    RfqLineItem[]

  @@index([sellerId])
  @@index([status])
  @@index([grade])
  @@index([origin])
  @@index([slug])
  @@map("products")
}

model Sku {
  id              String    @id @default(cuid())
  sku             String    @unique
  name            String    // e.g., "100g Tin", "1kg Bulk Bag"
  
  // Packaging
  weightGrams     Int
  packagingType   String?   // Tin, Bag, Box, etc.
  unitsPerCase    Int       @default(1)
  
  // Pricing
  basePrice       Decimal   @db.Decimal(10, 2)
  currency        String    @default("USD")
  
  // Status
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String
  
  priceTiers      PriceTier[]
  inventory       Inventory?
  rfqLineItems    RfqLineItem[]
  quoteLineItems  QuoteLineItem[]
  orderLineItems  OrderLineItem[]

  @@index([productId])
  @@index([sku])
  @@map("skus")
}

model PriceTier {
  id              String    @id @default(cuid())
  minQuantity     Int
  maxQuantity     Int?      // null = unlimited
  pricePerUnit    Decimal   @db.Decimal(10, 2)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  sku             Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  skuId           String

  @@index([skuId])
  @@map("price_tiers")
}

model Inventory {
  id              String    @id @default(cuid())
  quantityOnHand  Int       @default(0)
  quantityReserved Int      @default(0)
  reorderPoint    Int       @default(0)
  reorderQuantity Int       @default(0)
  
  lastRestockedAt DateTime?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  sku             Sku       @relation(fields: [skuId], references: [id], onDelete: Cascade)
  skuId           String    @unique

  @@map("inventory")
}

model ProductImage {
  id              String    @id @default(cuid())
  url             String
  altText         String?
  sortOrder       Int       @default(0)
  isPrimary       Boolean   @default(false)
  
  createdAt       DateTime  @default(now())
  
  // Relations
  product         Product   @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId       String

  @@index([productId])
  @@map("product_images")
}

// ============== RFQ, QUOTES & ORDERS ==============

model Rfq {
  id              String      @id @default(cuid())
  rfqNumber       String      @unique
  
  // Details
  title           String
  notes           String?
  
  // Shipping destination (for estimates)
  shipToCity      String?
  shipToState     String?
  shipToPostalCode String?
  shipToCountry   String      @default("US")
  
  // Dates
  neededByDate    DateTime?
  expiresAt       DateTime?
  
  // Status
  status          RfqStatus   @default(DRAFT)
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  buyer           BuyerProfile @relation(fields: [buyerId], references: [id])
  buyerId         String
  
  lineItems       RfqLineItem[]
  quotes          Quote[]
  messageThread   MessageThread?

  @@index([buyerId])
  @@index([status])
  @@index([rfqNumber])
  @@map("rfqs")
}

model RfqLineItem {
  id              String    @id @default(cuid())
  
  // Requested specs
  quantity        Int
  notes           String?
  
  // Target specs (optional - buyer may specify preferences)
  targetGrade     MatchaGrade?
  targetOrigin    MatchaOrigin?
  targetPriceMin  Decimal?  @db.Decimal(10, 2)
  targetPriceMax  Decimal?  @db.Decimal(10, 2)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  rfq             Rfq       @relation(fields: [rfqId], references: [id], onDelete: Cascade)
  rfqId           String
  
  // Optional: buyer can reference specific product/sku
  product         Product?  @relation(fields: [productId], references: [id])
  productId       String?
  
  sku             Sku?      @relation(fields: [skuId], references: [id])
  skuId           String?

  @@index([rfqId])
  @@map("rfq_line_items")
}

model Quote {
  id              String      @id @default(cuid())
  quoteNumber     String      @unique
  
  // Pricing summary
  subtotal        Decimal     @db.Decimal(10, 2)
  shippingCost    Decimal?    @db.Decimal(10, 2)
  taxAmount       Decimal?    @db.Decimal(10, 2)
  totalAmount     Decimal     @db.Decimal(10, 2)
  
  // Shipping details
  shippingMethod  ShippingMethod?
  estimatedDays   Int?
  
  // Terms
  notes           String?
  termsAndConditions String?
  validUntil      DateTime
  
  // Status
  status          QuoteStatus @default(DRAFT)
  
  submittedAt     DateTime?
  acceptedAt      DateTime?
  rejectedAt      DateTime?
  
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  
  // Relations
  rfq             Rfq         @relation(fields: [rfqId], references: [id])
  rfqId           String
  
  seller          SellerProfile @relation(fields: [sellerId], references: [id])
  sellerId        String
  
  lineItems       QuoteLineItem[]
  order           Order?

  @@index([rfqId])
  @@index([sellerId])
  @@index([status])
  @@index([quoteNumber])
  @@map("quotes")
}

model QuoteLineItem {
  id              String    @id @default(cuid())
  
  quantity        Int
  unitPrice       Decimal   @db.Decimal(10, 2)
  totalPrice      Decimal   @db.Decimal(10, 2)
  
  notes           String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  quote           Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  quoteId         String
  
  sku             Sku       @relation(fields: [skuId], references: [id])
  skuId           String

  @@index([quoteId])
  @@map("quote_line_items")
}

model Order {
  id              String        @id @default(cuid())
  orderNumber     String        @unique
  
  // Pricing
  subtotal        Decimal       @db.Decimal(10, 2)
  shippingCost    Decimal?      @db.Decimal(10, 2)
  taxAmount       Decimal?      @db.Decimal(10, 2)
  totalAmount     Decimal       @db.Decimal(10, 2)
  
  // Shipping
  shippingMethod  ShippingMethod?
  trackingNumber  String?
  shippedAt       DateTime?
  deliveredAt     DateTime?
  
  // Shipping address
  shipToName      String
  shipToLine1     String
  shipToLine2     String?
  shipToCity      String
  shipToState     String?
  shipToPostalCode String
  shipToCountry   String
  
  // Status
  status          OrderStatus   @default(PENDING)
  paymentStatus   PaymentStatus @default(PENDING)
  
  // Notes
  buyerNotes      String?
  sellerNotes     String?
  internalNotes   String?
  
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  
  // Relations
  quote           Quote         @relation(fields: [quoteId], references: [id])
  quoteId         String        @unique
  
  buyer           BuyerProfile  @relation("BuyerOrders", fields: [buyerId], references: [id])
  buyerId         String
  
  seller          SellerProfile @relation("SellerOrders", fields: [sellerId], references: [id])
  sellerId        String
  
  lineItems       OrderLineItem[]
  messageThread   MessageThread?

  @@index([buyerId])
  @@index([sellerId])
  @@index([status])
  @@index([orderNumber])
  @@map("orders")
}

model OrderLineItem {
  id              String    @id @default(cuid())
  
  quantity        Int
  unitPrice       Decimal   @db.Decimal(10, 2)
  totalPrice      Decimal   @db.Decimal(10, 2)
  
  createdAt       DateTime  @default(now())
  
  // Relations
  order           Order     @relation(fields: [orderId], references: [id], onDelete: Cascade)
  orderId         String
  
  sku             Sku       @relation(fields: [skuId], references: [id])
  skuId           String

  @@index([orderId])
  @@map("order_line_items")
}

// ============== MESSAGING ==============

model MessageThread {
  id              String    @id @default(cuid())
  subject         String?
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations - thread can be linked to RFQ or Order
  rfq             Rfq?      @relation(fields: [rfqId], references: [id])
  rfqId           String?   @unique
  
  order           Order?    @relation(fields: [orderId], references: [id])
  orderId         String?   @unique
  
  messages        Message[]

  @@map("message_threads")
}

model Message {
  id              String      @id @default(cuid())
  content         String
  type            MessageType @default(TEXT)
  
  isRead          Boolean     @default(false)
  readAt          DateTime?
  
  createdAt       DateTime    @default(now())
  
  // Relations
  thread          MessageThread @relation(fields: [threadId], references: [id], onDelete: Cascade)
  threadId        String
  
  sender          User        @relation("SentMessages", fields: [senderId], references: [id])
  senderId        String

  @@index([threadId])
  @@index([senderId])
  @@map("messages")
}

// ============== COMPLIANCE ==============

model ComplianceRule {
  id              String              @id @default(cuid())
  
  title           String
  description     String
  fullText        String?             // Detailed rule text
  
  // Categorization
  category        ComplianceCategory
  
  // Applicability
  countries       String[]            // Which countries this applies to
  productGrades   MatchaGrade[]       // Which grades this applies to (empty = all)
  
  // Requirements
  requirements    Json?               // { documents: [], certifications: [], etc. }
  
  // Status
  isActive        Boolean             @default(true)
  effectiveDate   DateTime?
  expirationDate  DateTime?
  
  // Source
  sourceUrl       String?
  sourceAuthority String?
  
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt
  
  // Relations
  createdBy       User                @relation(fields: [createdById], references: [id])
  createdById     String

  @@index([category])
  @@index([isActive])
  @@map("compliance_rules")
}

// ============== CONTENT ==============

model InsightPost {
  id              String            @id @default(cuid())
  
  title           String
  slug            String            @unique
  excerpt         String?
  content         String
  
  // Media
  featuredImageUrl String?
  
  // Categorization
  category        InsightCategory
  tags            String[]
  
  // Status
  isPublished     Boolean           @default(false)
  publishedAt     DateTime?
  
  // SEO
  metaTitle       String?
  metaDescription String?
  
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  
  // Relations
  author          User              @relation(fields: [authorId], references: [id])
  authorId        String

  @@index([category])
  @@index([isPublished])
  @@index([slug])
  @@map("insight_posts")
}

model TrendSeries {
  id              String    @id @default(cuid())
  
  name            String
  description     String?
  unit            String    // e.g., "USD/kg", "metric tons", "%"
  
  // Metadata
  source          String?
  frequency       String?   // daily, weekly, monthly
  
  isActive        Boolean   @default(true)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  // Relations
  dataPoints      TrendPoint[]

  @@map("trend_series")
}

model TrendPoint {
  id              String    @id @default(cuid())
  
  date            DateTime
  value           Decimal   @db.Decimal(12, 4)
  
  // Optional breakdown
  metadata        Json?     // { grade: "ceremonial", origin: "uji", etc. }
  
  createdAt       DateTime  @default(now())
  
  // Relations
  series          TrendSeries @relation(fields: [seriesId], references: [id], onDelete: Cascade)
  seriesId        String

  @@index([seriesId])
  @@index([date])
  @@map("trend_points")
}
